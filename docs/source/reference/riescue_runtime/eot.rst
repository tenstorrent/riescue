End of Test (EOT)
=================

Generates EOT code for ending the test. Writes to ``tohost`` to indicate a pass or fail.


``tohost``
-----------
The simulators Spike and Whisper use ``tohost`` to indicate the end of the test, defined in the ``io_htif`` sections.
Writing to ``tohost`` with ``lsb=1`` will end the test.
If ``[msb:lsb+1]`` is non zero and ``lsb=1`` the test is marked as a fail.
If ``[msb:lsb+1]`` is zero and ``lsb=1`` (value of ``0x1``) the test is marked as a pass.

You can find more information about ``tohost`` in this `Spike discussion
<https://github.com/riscv-software-src/riscv-isa-sim/issues/364#issuecomment-607657754>`_.



Riescue uses ``tohost`` in the ``io_htif`` sections to indicate the end of the test.
Other platforms may have different ways to indicate the end of the test.

.. important::
    This code was written with the assumption that only one hart will execute the end of test code and the test will always write to ``tohost``.
    Writing to ``tohost`` is a requirement to get ISS to end.

    Tests currently always write to ``tohost`` when using Riescue.


.. note::
    There's currently no mechanism to stop other tests from executing. Riescue relies on an EOT write to end the test for all harts.
    If this is a problem, file an issue on the `Riescue GitHub repository <https://github.com/tenstorrent/riescue/issues>`_ and request a feature.



Interface
---------

The EOT code is generated by the :py:class:`riescue.dtest_framework.runtime.eot.Eot` class.
It generates a few public routines that can be called by other code.

.. code-block::

    eot__end_test:

    eot__passed:

    eot__failed:

    eot__halt:



``eot__end_test``
___________________

This code is called at the end of the test for failures, passes, and halts.
It should be ran in the handler privilege mode and returns to ``M`` mode before ending the test.

Passing a value of ``1`` into ``gp`` will mark the test as passed, otherwise any other non-zero value will be marked as a fail


``eot__passed`` / ``eot__failed``
___________________________________

This code is called by ``eot__end_test`` to mark the test has passed or failed.


MP EOT
___________

MP code selects a single hart to write to ``tohost`` and then halts. The first hart to enter ``eot__end_test`` will be the one to write to ``tohost``.
All other harts will wait in the ``eot__halt`` routine until the first hart writes to ``tohost``.


Overriding EOT Code
--------------------

EOT hooks are available for inserting additional code at different points in the EOT code. The availabe hooks are:

- ``PRE_PASS``: Called before the test is marked as passed.
- ``POST_PASS``: Called after the test is marked as passed.
- ``PRE_FAIL``: Called before the test is marked as failed.
- ``POST_FAIL``: Called after the test is marked as failed.
- ``PRE_HALT``: Called before the test is halted.

See the :doc:`../python_api/FeatMgr` class for more information on how to use hooks.

Configuration
-------------

The ``tohost`` write value can be overridden by setting the ``eot_pass_value`` and ``eot_fail_value`` configuration options.

- ``eot_pass_value``: Value to write to tohost on test pass
- ``eot_fail_value``: Value to write to tohost on test fail


The ``tohost`` address can be configured by changing the ``htif`` section in the CPU configuration file.
If no ``htif`` section is provided, it will insert the address at the end of the runtime code (after the ``.section .text`` section).




Examples
---------

For more information on how to modify the end of test code, see the :doc:`../../user_guides/modifying_end_of_test` user guide.