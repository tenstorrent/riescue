Riescue Private Page-Maps Feature: Technical Summary
====================================================

Executive Summary
----------------

The Riescue framework has been enhanced with a **Private Page-Maps** feature that enables isolated address spaces for multiprocessor (MP) configurations. These are present in feat/private_maps_merge branch of the riescue git repository. This enhancement addresses a fundamental limitation where all HARTs (Hardware Threads) previously shared the same address space, which prevented proper testing of memory isolation and inter-process communication scenarios.

**New Capability**: With private maps, it is now possible to integrate the contents of ELF files into a test input .s file, and run those alongside test contents that may also include random tests generated by Voyager2. This enables comprehensive testing scenarios that combine pre-compiled ELF binaries (static content) with dynamically generated test content from tools like Voyager2.

**C Test Integration**: The `--cfiles` option enables C test development and integration into Riescue - both in single HART and multi-HART scenarios, independent of the private-maps feature. Using this option in addition to specifying any library source, tests can be written in C and integrated into Riescue. The C tests will need to clear their BSS and reinitialize all initialized data programmatically. However, the ELF integration environment can automatically handle BSS clearing and data initialization.

Problem Statement
----------------

**Original Limitation**: In multiprocessor configurations, all HARTs operated within a single shared address space. This limitation prevented:
- Testing of memory isolation between processors
- Validation of inter-process communication mechanisms
- Simulation of realistic multi-process environments
- Testing of page table isolation scenarios
- Integration of pre-compiled ELF binaries with generated test content
- Running mixed test scenarios with both static (pre-compiled ELF binaries) and dynamic (randomly generated tests from tools like Voyager2) content

**Additional Limitation**: The framework also had limitations with C program integration, which is addressed by the `--cfiles` option independent of the private-maps feature.

**Business Impact**: Without proper address space isolation, the framework could not generate comprehensive tests for modern multiprocessor systems that require memory protection and isolation between different execution contexts. Additionally, the inability to integrate ELF files limited the framework's ability to test real-world applications alongside generated test content. C program integration limitations are addressed by the `--cfiles` option.

Solution Architecture
--------------------

The Private Page-Maps feature introduces a multi-layered approach to address space isolation:

1. **Command-Line Interface Enhancement**
   - **File**: `riescue/dtest_framework/cmdline.json`
   - **Change**: Added `--private_maps` flag and `--cfiles` parameter
   - **Purpose**: Enables the private page-maps feature at runtime and specifies C file integration for test development and library function support

2. **Feature Management Integration**
   - **File**: `riescue/dtest_framework/featmanager.py`
   - **Change**: Added `self.private_maps = self.cmdline.private_maps`
   - **Purpose**: Propagates the private maps configuration throughout the framework

3. **Parser Modifications**
   - **File**: `riescue/dtest_framework/parser.py`
   - **Key Changes**:
     - Modified `__init__` to accept `cli_args` parameter
     - Enhanced `parse_page_mappings()` to handle private map creation by using a pair of (linear_name, map_name) as key instead of linear_name only
     - Added logic to create separate `ParsedPageMapping` instances for each page map in case of private mapping
     - Modified `parse_init_mem()` to support map-specific memory initialization. The ";#init_mem" keyword in the riescue source now allows a map name separated by a colon (e.g., ;#init_memory @0x10000: map0). The corresponding linear name is appended with underscore-map_name.
       
     - Enhanced support for ELF file integration and C library linking

   **Regular Expression Analysis (Line 316)**:
   ```python
   match = re.search(r"(\w+)\+(\w+)", val)
   ```
   This regex searches for patterns like `"parent+offset"` in linear names, where:
   - `(\w+)` captures the parent name (first group)
   - `\+` matches the literal plus sign
   - `(\w+)` captures the hexadecimal offset (second group)

   This enables linked page mappings where child mappings reference parent mappings with specific offsets.

4. **Pool Management Enhancements**
   - **File**: `riescue/dtest_framework/pool.py`
   - **Key Changes**:
     - Modified `add_parsed_page_mapping()` to handle (linear_name, map_name) pairs
     - Enhanced `get_parsed_page_mapping()` to accept (linear_name, map_name) pairs
     - Added `separate_lin_name_map()` for parsing map specifications

5. **Page Map Infrastructure**
   - **File**: `riescue/dtest_framework/lib/page_map.py`
   - **Changes**:
     - Added `in_private_map` flag to `Page` class

6. **Runtime Support**
   - **Files**: 
     - `riescue/dtest_framework/runtime/trap_handler.py`
     - `riescue/dtest_framework/runtime/syscalls.py`
   - **Purpose**: Provides C library support for memory mapping operations and ELF integration
   - The exception handler saves the registers on exception entry iff the --cfiles option is given. This is to ensure C-ABI compatibility. The handler must ensure that the register values that need to be changed must be modified on the stack. The registers are restored upon exit from exception handler, again, iff the --cfiles is specified.

**C Test Development**: The `--cfiles` option enables C test development and integration into Riescue, independent of the private-maps feature. C tests can be written for both single HART and multi-HART scenarios. However, C tests require manual BSS clearing and data initialization, while the ELF integration environment provides automatic BSS clearing and data initialization capabilities.

**Library Function Support**: The `--cfiles` option also serves as a library mechanism, allowing users to provide any functions needed by ELF files or C programs. This enables the integration of custom library functions, helper routines, and specialized implementations that may be required by specific test scenarios or applications.

**Advantages of C Test Integration**: C test integration is more inclusive and easier than writing assembly tests, making the framework more accessible to developers who prefer high-level programming languages. This capability significantly reduces the barrier to entry for test development while maintaining the framework's comprehensive testing capabilities.

**ELF Compilation Requirements**: Any integrated ELF files should be compiled statically without libstdc to ensure compatibility with the framework's runtime environment and to avoid dependencies on external libraries that may not be available in the target environment.

**Note**: The C library implementation (`riescue_lib_c.c`, `riscv_mmap.h`, `riscv_satp.h`) is experimental and will be replaced with a more robust implementation for production use. The current implementation provides basic memory mapping functionality as a proof-of-concept, but a more comprehensive and production-ready C library would provide better error handling, security features, and integration with the framework's testing capabilities.

----------------------------

**Backward Compatibility**
- The feature is opt-in via `--private_maps` flag
- Existing tests continue to work without modification
- Default behavior remains unchanged
- ELF integration is optional and configurable

**Performance Impact**
- Minimal overhead when feature is disabled
- Efficient page table management for isolated spaces
- Optimized memory allocation for private maps
- Efficient ELF file processing and symbol resolution

Conclusion
----------

The Private Page-Maps feature represents a significant enhancement to the Riescue framework, enabling comprehensive testing of multiprocessor systems with proper address space isolation. This enhancement addresses a critical gap in the framework's ability to test modern multiprocessor architectures and provides a foundation for advanced testing scenarios involving memory isolation, inter-process communication, and security validation.

**New Capabilities**: The addition of ELF file integration and Voyager2 compatibility enables the framework to support mixed test scenarios that combine pre-compiled applications with dynamically generated test content. This capability significantly expands the framework's utility for real-world application testing and comprehensive validation scenarios.

The implementation demonstrates careful consideration of backward compatibility, performance impact, and extensibility, making it a robust addition to the Riescue testing ecosystem.

**Key Features Added**:
- Private page map support with isolated address spaces
- C library runtime support for memory mapping
- **Comprehensive C library support for application testing**

This document describes the comprehensive enhancement of the Riescue framework to support private page-maps, enabling advanced multiprocessor testing scenarios with proper address space isolation, ELF file integration, and Voyager2 compatibility. 
