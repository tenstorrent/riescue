bootstrap: docker
From: rockylinux:9.1
Stage: devel

%environment
    export PATH=/usr/local/bin:${PATH}
    export LD_LIBRARY_PATH=/usr/lib64:${LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:}/shared

%runscript
    ulimit -s unlimited

%labels
    DESCRIPTION Please do not change the version, ./infra/container-push will update the version number here
    VERSION 1.27

%setup
    set -eux

%files
    pyproject.toml /app/
    README.md /app/
    riescue /app/riescue
    pyproject.toml /app/
    infra/build_spike.sh /build_spike.sh
    infra/build_whisper.sh /build_whisper.sh
    infra/build_base_deps.sh /build_base_deps.sh

%post
    # Base deps
    ./build_base_deps.sh


    # Python dependencies - install and uninstall riescue to add all dependencies
    python3 -m pip install wheel
    cd /app
    pip install -e .
    pip uninstall riescue -y
    cd -

    # non-packaged dependencies
    export NO_SINGULARITY=1

    echo "Building whisper"
    ./build_whisper.sh

    echo "Building spike"
    ./build_spike.sh
